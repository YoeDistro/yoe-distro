kind: pipeline
type: exec
name: default

environment:
  DOCKER_REPO=none
  LANG=en_US.UTF-8

platform:
  os: linux
  arch: arm64

clone:
  disable: true

trigger:
  branch:
    - master
    - feature-drone-exec-runner
  event:
    - push
    - pull_request

steps:
  - name: clone
    commands:
      - cd /scratch/drone-cache
      - echo "build number $DRONE_BUILD_NUMBER"
      - echo "building $${DRONE_GIT_HTTP_URL}, branch $${DRONE_REPO_BRANCH}"
      - export CACHE_DIR="$${DRONE_REPO_NAMESPACE}-$${DRONE_REPO_NAME}-$${DRONE_REPO_BRANCH}"
      - echo "CACHE_DIR $${CACHE_DIR}"
      - "[ -e $${CACHE_DIR} ] || git clone $${DRONE_GIT_HTTP_URL} $${CACHE_DIR}"
      - cd $${CACHE_DIR}
      - git checkout $${DRONE_REPO_BRANCH}
      - git pull
      - git checkout $DRONE_COMMIT_SHA
      - git submodule update --recursive --init

  - name: Env setup
    commands:
      - cd /scratch/drone-cache
      - echo "building $${DRONE_GIT_HTTP_URL}, branch $${DRONE_REPO_BRANCH}"
      - export CACHE_DIR="$${DRONE_REPO_NAMESPACE}-$${DRONE_REPO_NAME}-$${DRONE_REPO_BRANCH}"
      - echo "CACHE_DIR $${CACHE_DIR}"
      - cd $${CACHE_DIR}
      - echo "export DOCKER_REPO=none" > local.sh
      - echo "export LANG=en_US.UTF-8" >> local.sh
      - cp conf/local.conf.sample conf/local.conf
      - echo 'SSTATE_DIR = "/scratch/sstate-cache"' >> conf/local.conf
      - echo 'TMPDIR = "/scratch/tmp-$${DRONE_BUILD_NUMBER}"' >> conf/local.conf
      - echo 'IMAGE_CLASSES += "testimage testsdk"' >> conf/local.conf
      - echo 'INHERIT += "report-error rm_work"' >> conf/local.conf
      #- echo 'TESTIMAGE_AUTO_qemuall = "1"' >> conf/local.conf
 
  - name: build
    commands:
      - cd /scratch/drone-cache
      - echo "building $${DRONE_GIT_HTTP_URL}, branch $${DRONE_REPO_BRANCH}"
      - export CACHE_DIR="$${DRONE_REPO_NAMESPACE}-$${DRONE_REPO_NAME}-$${DRONE_REPO_BRANCH}"
      - echo "CACHE_DIR $${CACHE_DIR}"
      - cd $${CACHE_DIR}
      - /bin/bash -c ". ./qemux86-64-envsetup.sh && bitbake yoe-simple-image"

  - name: sstate clean
    commands:
      - cd /scratch/drone-cache
      - echo "building $${DRONE_GIT_HTTP_URL}, branch $${DRONE_REPO_BRANCH}"
      - export CACHE_DIR="$${DRONE_REPO_NAMESPACE}-$${DRONE_REPO_NAME}-$${DRONE_REPO_BRANCH}"
      - echo "CACHE_DIR $${CACHE_DIR}"
      - cd $${CACHE_DIR}
      - /bin/bash -c ". ./qemux86-64-envsetup.sh && yoe_clean_sstate"
      - rm -rf /scratch/tmp-$${DRONE_BUILD_NUMBER}
